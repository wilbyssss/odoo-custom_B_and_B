<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <template id="report_turn_over_template">
    <t t-call="web.basic_layout">
      <main class="o_main_report_layout">
        <t t-foreach="docs" t-as="wizard">
          <!-- CORRIGÉ -->
          <t t-set="data" t-value="wizard._get_turn_over_data()" />
          <t t-set="lines" t-value="data['report_data']" />

          <div class="page">
            <!-- EN-TÊTE (identique) -->
            <table class="table table-borderless" style="width:100%; border-bottom:2px solid #000;">
              <tr>
                <td style="width:25%; vertical-align:top;">
                  <img t-if="wizard.company_id.logo"
                       t-att-src="'data:image/png;base64,' + wizard.company_id.logo.decode('utf-8')"
                       style="max-height:120px;" alt="Logo"/>
                </td>
                <td style="width:75%; vertical-align:top; text-align:right; font-size:12px;">
                  <strong style="font-size:14px;"><t t-esc="wizard.company_id.name"/></strong><br/>
                  Production - Représentation - Distribution de produits cosmétiques<br/>
                  N° Contribuable : <strong><t t-esc="wizard.company_id.vat or ''"/></strong><br/>
                  RCCM : <strong><t t-esc="wizard.company_id.company_registry or ''"/></strong><br/>
                  BP : <strong><t t-esc="wizard.company_id.zip or ''"/> <t t-esc="wizard.company_id.city or ''"/></strong><br/>
                  Tél : <strong><t t-esc="wizard.company_id.phone or ''"/> / <t t-esc="wizard.company_id.mobile or ''"/></strong><br/>
                  Siège : <strong><t t-esc="wizard.company_id.street or ''"/> - <t t-esc="wizard.company_id.city or ''"/></strong>
                </td>
              </tr>
            </table>

            <h2 style="text-align:center; color:black; margin:20px 0 10px;">Chiffre d'affaire - Global</h2>
            <p style="text-align:center; margin-bottom:10px;">
              <strong>Période :</strong> <t t-esc="wizard.start_date"/> au <t t-esc="wizard.end_date"/>
            </p>

            <table class="table table-sm" style="width:100%; border-collapse:collapse; margin-top:10px;">
              <thead style="background-color:#27ae60; color:white;">
                <tr>
                  <th style="border:1px solid black; padding:4px;">Catégorie / Rayon</th>
                  <th style="border:1px solid black; padding:4px;">Achat</th>
                  <th style="border:1px solid black; padding:4px;">Vente</th>
                  <th style="border:1px solid black; padding:4px;">Marge</th>
                </tr>
              </thead>
              <tbody>
                <t t-foreach="lines.items()" t-as="parent">
                  <tr style="background-color:#ecf0f1;">
                    <td style="border:1px solid black; padding:4px; font-weight:bold;">
                      <t t-esc="parent[0]" />
                    </td>
                    <td style="border:1px solid black; padding:4px; text-align:right;">
                      <t t-esc="'{:,.2f}'.format(parent[1]['total_achat'])" />
                    </td>
                    <td style="border:1px solid black; padding:4px; text-align:right;">
                      <t t-esc="'{:,.2f}'.format(parent[1]['total_vente'])" />
                    </td>
                    <td style="border:1px solid black; padding:4px; text-align:right;">
                      <t t-esc="'{:,.2f}'.format(parent[1]['total_vente'] - parent[1]['total_achat'])" />
                    </td>
                  </tr>
                  <t t-foreach="parent[1].get('rayons', {}).items()" t-as="rayon">
                    <tr>
                      <td style="border:1px solid black; padding:4px; padding-left:25px;">
                        <t t-esc="rayon[0]" />
                      </td>
                      <td style="border:1px solid black; padding:4px; text-align:right;">
                        <t t-esc="'{:,.2f}'.format(rayon[1]['total_achat'])" />
                      </td>
                      <td style="border:1px solid black; padding:4px; text-align:right;">
                        <t t-esc="'{:,.2f}'.format(rayon[1]['total_vente'])" />
                      </td>
                      <td style="border:1px solid black; padding:4px; text-align:right;">
                        <t t-esc="'{:,.2f}'.format(rayon[1]['total_vente'] - rayon[1]['total_achat'])" />
                      </td>
                    </tr>
                  </t>
                </t>
              </tbody>
            </table>

            <!-- TOTAUX GLOBAUX -->
            <div style="margin-top:30px; display:flex; justify-content:space-between;">
              <div>
                <table class="table table-sm">
                  <tr><th>Module</th><th>Total</th></tr>
                  <tr><td>Vente</td><td><t t-esc="'{:,.2f}'.format(data.get('vente', 0.0))"/></td></tr>
                  <tr><td>Point de vente</td><td><t t-esc="'{:,.2f}'.format(data.get('pos', 0.0))"/></td></tr>
                </table>
              </div>
              <div style="text-align:right;">
                <p><strong>Total Achat :</strong> <t t-esc="'{:,.2f}'.format(data['total_general_achat'])"/></p>
                <p><strong>Total Vente :</strong> <t t-esc="'{:,.2f}'.format(data['total_general_vente'])"/></p>
                <p><strong>Total Marge :</strong> <t t-esc="'{:,.2f}'.format(data['total_general_marge'])"/></p>
              </div>
            </div>
          </div>
        </t>
      </main>
    </t>
  </template>
</odoo>